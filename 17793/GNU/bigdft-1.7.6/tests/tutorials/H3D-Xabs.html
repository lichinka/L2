<?xml version="1.0" encoding="iso-8859-15"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <title>Tutorial: Xanes: calculating the spectra of Quartz</title>
    <meta name="copyright" content="&#169; 2004-2011 CEA" />
    <link rel="author" type="text/html" href="http://www.cea.fr" hreflang="fr" lang="fr" />
    <link rel="stylesheet" type="text/css" href="../styles/original.css" />
  </head>

  <body>

    <div class="header">
      <div class="visuLogo">
        <img src="../images/logo_header.png" alt="" width="102" height="80" />
      </div>
      <!-- %%VERSION%% --><
    </div>

    <!-- %%MENU%% -->

    <div class="main"><a name="top" id="top"></a>

      <div class="floatingmenu">
        <a href="H3C-Wannier.html">&lt;&nbsp;prev. lesson</a>
        <a style="float:right;" href="H1A_first_run.html">First lesson&nbsp;&gt;</a>
        <h2>Content of this lesson</h2>
        <ul>
          <li> Patching a pseudopodential with a PAW correction:</li>
	      <ol> <ul>
		  <li> Generation of ptildes and psitildes to increase the psp energy range. </li>
                  <li> Fitting ptildes with complex gaussians. </li>
	      </ul></ol>
          <li> Generating an SCF potential for a small unit cell.</li>	
          <li> Generating the spectra:</li>
		<ol><ul>
                    <li>  Dependence on nkpts, number of Chebyshev  components, polarisation, charge ... </li>
                    <li>  Comparison to experimental data.</li>
                    </ul>
                </ol>
        </ul>
        <h2  ALIGN="CENTER">Material : files are generated by <code>make exercise</code> in each subdir</h2>
        <ul style="float:left;margin-right:1em;">
	    <h3>Xabs/pawpatchgen/</h3>
           <li><a  type="text/plain"  href="Xabs/pawpatchgen/atom.dat" target="_blank">atom.dat</a></li>
           <li><a  type="text/plain"  href="Xabs/pawpatchgen/input.dat" target="_blank">input.dat</a></li>
           <li><a  type="text/plain"  href="Xabs/pawpatchgen/psppar.P" target="_blank">psppar.P</a></li>
           <li><a  type="text/plain"  href="../../pseudo/src/pawpatchfit.py" target="_blank">pawpatchfit.py</a></li>
        </ul>
       <ul style="float:left;margin-right:1em;">
	    <h3>Xabs/scfpotgen/</h3>
           <li><a type="text/plain"  href="Xabs/scfpotgen/posinp.xyz" target="_blank">posinp.xyz</a></li>
           <li><a type="text/plain"  href="Xabs/scfpotgen/input.dft" target="_blank">input.dft</a></li>
           <li><a type="text/plain"  href="Xabs/scfpotgen/psppar.O" target="_blank">psppar.O</a></li>
           <li><a type="text/plain"  href="Xabs/scfpotgen/psppar.Si" target="_blank">psppar.Si</a></li>
           <li><a type="text/plain"  href="Xabs/scfpotgen/psppar.P" target="_blank">psppar.P</a></li>
           <ol>   optional bigger cell<ul>
           <li><a type="text/plain"   href="Xabs/scfpotgen/posinp.xyz_72p" target="_blank">posinp.xyz_72p</a></li>
	    </ul></ol>
        </ul>
       <ul style="float:left;margin-right:1em;">
	    <h3>Xabs/spectra/</h3>
           <li><a type="text/plain" href="Xabs/spectra/input.abscalc" target="_blank">input.abscalc</a></li>
           <li><a type="text/plain" href="Xabs/spectra/input.dft" target="_blank">input.dft</a></li>
           <li><a type="text/plain" href="Xabs/spectra/input.kpt" target="_blank">input.kpt</a></li>
           <li><a type="text/plain" href="Xabs/spectra/psppar.O" target="_blank">psppar.O</a></li>
           <li><a type="text/plain" href="Xabs/spectra/psppar.Si" target="_blank">psppar.Si</a></li>
           <li><a type="text/plain" href="Xabs/spectra/posinp.xyz" target="_blank">posinp.xyz</a></li>
           <ol>   optional bigger cells<ul>
           <li><a type="text/plain"   href="Xabs/spectra/posinp_72X8p.xyz" target="_blank">posinp_72X8p.xyz</a></li>
           <li><a type="text/plain"   href="Xabs/spectra/posinp_72X27p.xyz" target="_blank">posinp_72X27p.xyz</a></li>
	    </ul></ol>
        </ul>
      </div>

    
      <h1>Xanes: Calculating the spectra of quartz</h1>

      <p>The purpose of this lesson is to get familiar with the steps required 
         to generate an x-ray absorption spectra, in particular in the Xanes region.
         These steps are three : </p> 
      <p>
	<ul>
	  <li> the first step  consists in generating a PAW patch for the pseudopotential 
               in order to extend its validity over the Xanes region.	 This region corresponds to photo-electron 
               energy from zero to few Hartree. We will do this using <b> atom </b>
                and <b>pseudo</b> programs which are distributed with the BigDFT project.   
          </li>

	  <li>  The potential felt by the photoelectron can be generated by 
                a standard BigDFT run. 
	        A non SCF potential can also be generated  summing atomic densities. This can be done 
                using abscalc with the  appropriate option.
	  </li><li>  We will calculate the spectra using a paw-patched pseudopotential and the local potential
                 from a BigDFT calculation. Using several k-points is equivalent to calculate the spectra
                 in a larger cell whose size is a multiple of the unit cell. The number of k-points is important to get 
	         smoother spectra free from spurious band discrete sampling effects.
	         We will explore the importance of this parameters and of other parameters like the charge of the system,
	         and the light polarisation.
	  </li>
	  </ul>
	 </p> <p>
	This lesson may take XX minutes for the basic point and we give track for further testing.
	We suggest to coordinate your runs with  your neighbours so that the test of the dependancies 
	   on different choices of certain parameters can be parallelised.
	</p>
	  <h2>  Patching a pseudopodential with a PAW correction </h2>
	  <h3> Generating the potential of the AE reference </h3>
	  <p>
	    Our goal is to calculate the Xanes spectra of Quartz at the K edge of Silicon. In order to do so we need to construct 
	  a pseudopotential, with the program pseudo,  which describes a Silicon atom with one hole in the 1s shell.
	  Asimple way to do this, that we will follow here, consistes in  starting  from the pseudopotential 
	    of the Z+1 element, (Phosphorus in this case), that we will patch with a PAW correction
	  that we are going to build. The Z+1 approximation consists in replacing a Z nuclear charge plus on 1s electron,
          with a Z+1 nuclear charge plus two electron. This keeps the total charge unchanged. It would  possible, 
	  with the program pseudo, to generate a new pseudopotential for Silicon with one hole, and then patch it.
	  We focus here instead on building only the PAW correction which is the original part of this method,
	  and we start therefore directly from the Z+1 pseudopotential which is already given.</p>
	  <p>
	  The calculation proceed in two steps. First we generate with the program atom  the very same all-electron (AE)
	  reference that has been used to create the pseudopotential. This first step is used to generate a radial 
	  potential that will be used, in the second step,  to generate AE eigenfunctions over a wide energy range.
	  </p><p>
	  In the second step  we create the PAW correction such that the patched pseudo potential can fit the AE energy
	  over a wider range.
	  </p><p>
	  The first step is quickly accomplished with the following command

	  <div class="exercice">
            <p><b>Exercise</b>: run <code>`../../../../pseudo/src/atom  atom.dat`</code> </p>
	  </div>
	  
	  where file <a  type="text/plain"  href="Xabs/pawpatchgen/atom.dat" target="_blank"><code>atom.dat</code></a> is the one used
	  as reference for the <a  type="text/plain"  href="Xabs/pawpatchgen/psppar.P" target="_blank"><code>psppar.P</code></a>
	  pseudopotential.


<div style="height:120px;overflow:scroll;">
<pre>	  
  P
  -20
  relativistic
       25.0      10.0 60.0       rmax,aa,bb 
       2.09d0   4.19d0		 rcov,rprb
    3    13			 number of core and valence orbitals
    3    0     2.00      0.00		   
    4    0     0.00      0.00		   
    5    0     0.00      0.00		   
    6    0     0.00      0.00		   
    3    1     3.00      0.00		   
    4    1     0.00      0.00		   
    5    1     0.00      0.00		   
    6    1     0.00      0.00		   
    3    2     0.00      0.00		   
    4    2     0.00      0.00		   
    5    2     0.00      0.00		   
    4    3     0.00      0.00		   
    5    3     0.00      0.00		   
</pre>
</div>
<p>
the format of <a  type="text/plain"  href="Xabs/pawpatchgen/atom.dat" target="_blank"><code>atom.dat</code></a> is quite simple.
On the first line we find the atomic symbol(P). Then the XC functional code ( here -20=LDA).
The fourth line contains some information on how atom must build the radial logarithmic grid.
The fifth line contains the covalent radius and the radius of the parabolic potential.
On the sixth line the first number that we find indicates how many core  bottom orbitals are fully occupied.
Here 3 means that 10 electron occupies 1s, 2s and 2p.
The second number is the number of valence orbitals that have been  calculated
by atom when   the reference for pseudo was generated. Here we are concerned only by those orbital
which have non zero occupancies. These are the one which  have influence  on  the local potential.
</p>
<p>
At the end of the run you should get in your working directory the file 
<a href="Xabs/pawpatchgen/ae.pot.conf.0.plt" target="_blank">   ae.pot.conf.0.plt</a>

which is the potential for configuration 0 ( pseudo can fit a pseudo potential against a set of configurations, here we have just one ).
</p>

<h3>Generation of ptildes and psitildes to increase the psp energy range. </h3>

<p>
  You are ready to generate the paw-patch :
 	  <div class="exercice">
            <p><b>Exercise</b>: run <code>`../../../../pseudo/src/pseudo  input.dat`</code> </p>
	  </div>
	  
</p>
This program, besides <i> input.dat</i>, reads several files generated by atom, and the file <i> psppar </i>
containing the initial psp parameters. In out case we dont fit the psp parameter, so <i> psppar</i>
must be coherent with the pseudopotential <i>psppar.P</i> that we want to patch.

<p>It is important to explain the option used in <a href="Xabs/pawpatchgen/input.dat" target="_blank">   input.dat</a> because you 
will have to fine tune them</p>
<pre>	  
-c 0 -plot -paw 0  -noflpaw 3  -nchannelspaw 2  
-pawstatom ae.pot.conf.0.plt -pawstn 1 -pawstl 0 -pawstp 1  
</pre>
<p><ul>
<li> the first two option :<code>-c0 -plot </code> tell pseudo not to fit the psp parameters, we already have that we already know :
  <a  type="text/plain"  href="Xabs/pawpatchgen/psppar.P" target="_blank"><code>psppar.P</code></a>
</li>
<li>  <b>-paw</b> 0  means : do the patch for configuration number 0    </li>
<li> <b>-noflpaw</b> 3 means that the correction are calculated of three values of angular moment : s, p and d waves.
  We suppose here that the correction for f waves would be here negligeable. </li>
<li> <b>-nchannelspaw</b> 2  means that for each angular moment two projectors are generated.
   The more projectors one has the bigger the energy range where the correction is good. </li>
<li> <b>-pawstatom</b> ae.pot.conf.0.plt  reads the local potential from file  ae.pot.conf.0.plt that we generated with atom. </li>

<p><i> the following items concern the generation of the initial photoelectron wavefuction </i></p>
<li>  <b>-pawstn</b> 1   we want to generate a wavefunction from 1s. Quantum number n is therefore 1 here </li>
<li> <b>-pawstl</b> 0   For the same reason above, we indicate here that quantum number l is 0 </li>
<li> <b>-pawstp</b> 1   This is the power of r by which we multiply the radial part of the initial wave fuction. The angular part is take care of by BigDFT ( abscalc)
                        when the polarisation is known. For dipolar interaction pawstp is 1, for quadrupolar  it is 2 and so on.    </li>
</ul></p>

<p> The result of the fit can be monitored looking at the output. Here below we report the output concerning the  <code>l=0</code> space</p>


<div style="height:220px;overflow:scroll;">
<pre>	  
 ===============================================================
 ========== now CALCULATING PAWpatch correction  for l  =             0
 ===============================================================
 now calculating          100  function of the AE basis for LPaw=           0
 doing the fit 
  routine gatom_modified  ,  comparaison between  first 5 energies real and  pseudo-not_fitted 
           1  -75.952756404876709     
           2  -6.2910273671150208     
           3  0.41157764650931183       0.37085166222413934     
           4   5.9902891679064592        2.6090777062770307     
           5   14.400375561474663        6.4202517989703054     
 >>  Comparaison betwenn first 5 Egrid and   Egrid_pseudo 
  -75.952756404876709     
  -6.2910273671150208     
  0.41157764650931183       0.41157765025060822     
   5.9902891679064592        5.9902845552977215     
   14.400375561474663        14.399645486591949     
DUALITY : CONDITION NUMBER FROM DPOSVX  0.5501E+00
  first  eigenvalues 
  0.41116489582251731     
   2.9722717862947752     
   7.7169956612536588     
   13.735301520083759     
 routine pawpatch  , PROJECT  initial wf*r**pawstP on pseudos 
 From initial wave  subtract psigrid_bigger(           1 ) with coeff   0.10433231170909278     
 From initial wave  subtract psigrid_bigger(           2 ) with coeff  -3.29213674528539627E-002
 Initial Projected wf at igrid=100,500,2000
 -1.19502133768229197E-007
 -2.11513353895853788E-007
 -1.97394835887812979E-006
</pre>
</div>
<p> We can see here, below the line <code> comparaison between  first 5 energies real and  pseudo-not_fitted </code>
that, without the PAW patch, the eigenvalues  of the radial solution calculated in the AE 
potential diverges at high energies from those calculated in the pseudo potential, while in the
valence region the used  psppar.P pseudopotential fits well the AE solution within some thousandth of Hartree. <i>Nota Bene</i> that the 
radial solution is calculated from zero to the covalent radius, and this pushes the first pseudo eigenvalue
at positive energy where the difference with the AE solution is already of the order of some hundreth of Hartree.</p>
<p>
The lines below <code>   Comparaison between first 5 Egrid and   Egrid_pseudo  </code>
 show the corrected eigenvalues for a modified pseudo potential where, for each eigenvalue,
we add a short range gaussian at the nucleus with an appropriate factor such that the AE eigenvalue is recovered.
These eigensolution are our <i>psitildes</i> which  are not orthonormal but outside the core region they coincide 
with the AE solutions.</p>
<p> 
 By solving a simple linear equation we get the <i>ptildes</i> as the dual of the <i>psitildes</i> 
(line <code> DUALITY : CONDITION NUMBER FROM DPOSVX  0.5501E+00 </code>).
Once the <i>psitildes</i> and <i>ptildes</i> are know, the PAW patch is calculated as a correction
in the nchannelspaw-dimensional space spanned by <i>psitildes</i>.</p>

<p> Such correction is tested in the space spanned by the pseudo solutions ( which has a dimension of the order of 
100) and the results are plotted for comparaison.  </p>


<div class="exercice">
  <p><b>Exercise</b>: increase nchannespaw to improve the fit of the second pseudo eigenvalue </p>
</div>

<div class="exercice">
  <p><b>Exercise</b>: plot AE solutions (<i>file ae.wfs.L=0.plt </i>) and   psitildes (<i> file psitildes.L=0.plt</i>)
to verify that they really coincide outside of the core </p>
</div>

<div class="exercice">
  <p><b>For future use:</b>: -pawrcovfact0.8 or another factor can be used to change the psitildes/ptildes support </p>
</div>

 <img class="figure" src="Figures/H3Xabs-aspsitildejoin.png" alt="The psitilde joins ae wf outside of the core" />
 

<h3>Fitting ptildes with complex gaussians. </h3>

Finally the PAW patch is generated with the following command for L from 0 to 2 and using 30 complex gaussians
 
<div class="exercice">
  <p><b>Exercise</b>: run <code>`python pawpatchfit.py 0 2 30 `</code> </p>
</div>

This script create an output : <i> file pseudopaw</i> containing a description of the <i> ptildes </i> , of the initial wave function  projection in the space of pseudo-functions, for different values of  L, and the correction in the form of a numerical matrix. 
The quality of the fit can be observed plotting  these files: 
<div style="height:220px;width:250px;">
<pre>	  
fitresult_l_2_initial
fitresult_l_2_channel_1
fitresult_l_2_channel_0
fitresult_l_1_initial
fitresult_l_1_channel_1
fitresult_l_1_channel_0
fitresult_l_0_initial
fitresult_l_0_channel_1
fitresult_l_0_channel_0
</pre>
</div>

<p>
each file contains four columns : the radial position, the original numerical function, the fit to function as a sum of complex gaussian, the error.
</p>
<p>
Now the last step. Create the patched pseudopotential file ready for the spectra!!.
This is done postpending <i>  file pseudopaw</i> to <i> psppar.P</i>
</p>

<div class="exercice">
  <p><b>Exercise</b>: run <code>`cat psppar.P pseudopaw > psppar.P_1s`</code> </p>
</div>

<p>
</p>
<h2>Generating an SCF potential for a small unit cell </h2>

<p>
 This is done with a BigDFT run in directory <i>  Xabs/scfpotgen </i>.
 The unit cell contains 18 atoms, corresponding to the structure of Quartz, with one Silicon substituted
by Phosphorus. In <i>  input.dft </i> we have 
set a charge of 1. The run is fast enough so that, using different parameters,
 you may eventually generate alternative potentials to be used for the additional spectra calculation.
 You will do this  if you have enough cpus to run multiple spectra in parallel or it you have enough time.
To generate an SCF potential, when you are in directory <i> Xabs/scfpotgen</i> </p>
<div class="exercice">
  <p><b>Exercise</b>: run <code>`mpirun -n XXXX  ../../../../src/bigdft`</code> </p>
</div>
<p>
the potential is written to the disk in the <i> cube </i> format when 
in file input.dft    <i> output_grid </i> is set to 2.
The created potential is  <i> data/local_potential.cube </i>.
 </p>
<p>
There is also the possibility to generate a potential from straightforward sum
of atomic charges. This is done running <i> abscalc </i> program.
The  <i> abscalc </i> program reads  <i> input.abscalc </i>  
whose key <i> pot_shortcut </i> is set to option 1 ( linear superposition of charges )
Option  <i> pot_shortcut=2</i> means instead that the local potential
is read from file.
</p>
<div class="exercice">
  <p><b>Optional exercise</b>: run <code>`../../../../src/abscalc`</code> </p>
</div>
<p>
the local potential is then written to local_potentialb2B.cube
</p>

<h2> Generating the spectra  </h2>

<p>
The directory <i> Xabs/spectra </i> is almost already set-up with input files to run 
a spectra calculation. To finalize the set-up you must <b> copy the patched pseudopotential, that 
you created, into the work directory </b> and <b> copy or create a link</b> of Xabs/scfpotgen/data/local_potential.cube 
<b> to a file named b2B_xanes.cube</b>. The prefix b2B stands for <i> box to box </i>  which is the name of the routine
which interpolate a potential from a given unit cell (box) to another unit cell. The unit cells must either
have the same shape and same atomic positions or the target cell can be a multiple of the input cell. 
</p>

<p> In out set-up we use the same <b><i> posinp.xyz </i></b> used in SCF calculation except that 
we have changed the name of the absorbing atom <b> from P to P_1s </b> so that the
absorbing atom (<i> that the absorbing atom is the first is indicated in input.abscalc </i>)
will use a patched pseudo-potential.<p>

<p> The unit cell that we use is quite small to keep the tutorial fast  and,
 to increase the number of states  in the continuous region, we specify 
in <b> input.kpt</b> the  inverse of the k-lenght of the reciprocal sampling
 which is larger than the unit cell diameter. </p>

<p> You can dry-check how many k-points you have with the memguess program.
The given setup generates 6 kpoints. You can run it :
</p>
 <div class="exercice">
  <p><b>Exercise</b>: run <code>`mpirun -n 4 ../../../../src/abscalc`</code> </p>
</div>
</p>

<p>  which should take XXX minutes.  As explained in the lesson the method does a systematic refinement
of the spectra, adding at each iteration two Chebyshev components.  The spectra is plotted every 100 iterations
on file Zb_cheb_spectra_XXXX.  Where XXXX is the number of components.
We show here the spectra with 4000 components for a kptrlenght of 22 Bohr (6 kpoints)  and    50Bohr  (X kpoints ),
and another spectra done using the bigger posinp_72p.xyz (72 atoms)  cell and  50Bohr (X kpoints ).
 <img class="figure" src="H3Xabs-comp_exppar_fewk.png" alt="Quartz spectra for c-axis polarisation in the case of a 18 atoms cell and kptrlenght 22 a.u" />

We see that for our small cell the spectra is not yet converged because the absorbing Phosphorus  site
has in the SCF a deformation of the potential respect to the rest of the lattice, and this deformation 
 <img class="figure" src="H3Xabs-comp_exppar_manyk.png" alt="Quartz spectra for c-axis polarisation in the case of a 18 atoms cell and kptrlenght 50 a.u" />
is reproduced at periodic intervals in our calculation which is based on periodic boundary conditions and k-points..
In the case of a small cell the oscillations correspond to scattering of the photolectron on 
other Phosphorus sites. 

</p> 
 
<p> The obtained spectra can be compared with figure 2 of <a    href=" http://arxiv.org/abs/cond-mat/0207733v1" target="_blank">http://arxiv.org/abs/cond-mat/0207733v1
</a>.

We produce here the analogous picture where the experimental data has been digitalized from that figure,
and the calculation is done with posinp_72p.xyz and  and  a 50Bohr lenght for the reciprocal space.
</p>

 <img class="figure" src="H3Xabs-comp_exppar.png" alt="Quartz spectra for c-axis polarisation in the case of a 72 atoms cell and kptrlenght 50 a.u" />
 


<p> As optional exercise you can test different parameters for the polarisation. If you have enough computing power you can 
   increase the number of k-points by increasing the lenght given in input.kpt, or play with bigger cells.
</p>


</div>

    <div class="footer">Author (Alessandro Mirone ESRF )
      |
      <a href="http://validator.w3.org/check/referer" title="Check HTML compliance with W3C norms">XHTML1.0</a> - 
      <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Check CSS compliance with W3C norms">CSS2</a>
      |
      <!-- hhmts start -->
      Fri Oct  7 13:43:23 CEST 2011
      <!-- hhmts end -->
    </div>

  </body>
</html>
